# SF2 to OP-XY Converter Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a standalone, MIT-licensed repo that converts SF2 instruments/drum kits to OP-XY multisample/drum presets with envelope + FX send mapping and detailed logging.

**Architecture:** Python CLI + small library. `sf2_reader` parses SF2 with sf2utils, `selection` handles velocity and zone downselect, `converter` maps SF2 → OP-XY model, `opxy_writer` emits `.preset` directories, and tests validate mapping math and CLI behavior.

**Tech Stack:** Python 3, sf2utils, pytest.

---

### Task 1: Repo scaffold + CLI smoke test

**Files:**
- Create: `README.md`
- Create: `LICENSE`
- Create: `NOTICE.md`
- Create: `requirements.txt`
- Create: `requirements-dev.txt`
- Create: `sf2_to_opxy.py`
- Create: `src/sf2_to_opxy/__init__.py`
- Create: `src/sf2_to_opxy/cli.py`
- Test: `tests/test_cli.py`

**Step 1: Write the failing test**

```python
# tests/test_cli.py
import subprocess
import sys

def test_help_runs():
    result = subprocess.run([sys.executable, "sf2_to_opxy.py", "--help"], capture_output=True, text=True)
    assert result.returncode == 0
    assert "SF2 to OP-XY" in result.stdout
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/test_cli.py -v`
Expected: FAIL because `sf2_to_opxy.py` and CLI module do not exist.

**Step 3: Write minimal implementation**

```python
# src/sf2_to_opxy/cli.py
import argparse

def build_parser() -> argparse.ArgumentParser:
    parser = argparse.ArgumentParser(description="SF2 to OP-XY converter")
    # args will be filled in later tasks
    return parser

# sf2_to_opxy.py
from sf2_to_opxy.cli import build_parser


def main() -> int:
    parser = build_parser()
    parser.parse_args()
    return 0

if __name__ == "__main__":
    raise SystemExit(main())
```

**Step 4: Run test to verify it passes**

Run: `pytest tests/test_cli.py -v`
Expected: PASS.

**Step 5: Commit**

```bash
git add README.md LICENSE NOTICE.md requirements.txt requirements-dev.txt sf2_to_opxy.py src/sf2_to_opxy/__init__.py src/sf2_to_opxy/cli.py tests/test_cli.py
git commit -m "chore: scaffold repo and cli"
```

---

### Task 2: Port core parsing + selection + writer (baseline behavior)

**Files:**
- Create: `src/sf2_to_opxy/audio.py`
- Create: `src/sf2_to_opxy/selection.py`
- Create: `src/sf2_to_opxy/sf2_reader.py`
- Create: `src/sf2_to_opxy/converter.py`
- Create: `src/sf2_to_opxy/opxy_writer.py`
- Test: `tests/test_selection.py`
- Test: `tests/test_audio.py`
- Test: `tests/test_converter.py`

**Step 1: Write the failing tests**

```python
# tests/test_selection.py
from sf2_to_opxy.selection import select_zones_for_88_keys, assign_key_ranges


def test_select_evenly_spaced():
    zones = [{"root_key": k} for k in range(21, 109)]
    selected = select_zones_for_88_keys(zones, 24, 21, 108)
    assert len(selected) == 24


def test_assign_key_ranges_bounds():
    zones = [{"root_key": 40}, {"root_key": 60}, {"root_key": 80}]
    assigned = assign_key_ranges(zones, 21, 108)
    assert assigned[0]["lokey"] == 21
    assert assigned[-1]["hikey"] == 108
```

```python
# tests/test_audio.py
from sf2_to_opxy.audio import resample_linear


def test_resample_linear_identity():
    pcm = [0, 100, -100, 50]
    assert resample_linear(pcm, 22050, 22050) == pcm
```

```python
# tests/test_converter.py
from sf2_to_opxy.converter import _sanitize_name


def test_sanitize_name():
    assert _sanitize_name("My*Preset") == "My_Preset"
```

**Step 2: Run tests to verify they fail**

Run: `pytest tests/test_selection.py tests/test_audio.py tests/test_converter.py -v`
Expected: FAIL because modules do not exist.

**Step 3: Write minimal implementation**

- Port `audio.py`, `selection.py`, `sf2_reader.py`, `converter.py`, `opxy_writer.py` from the existing tool.
- Keep current behavior: velocity filtering, zone downselection to 24, A0–C8 mapping, optional resample, loop points, and drum detection by bank==128.

**Step 4: Run tests to verify they pass**

Run: `pytest tests/test_selection.py tests/test_audio.py tests/test_converter.py -v`
Expected: PASS.

**Step 5: Commit**

```bash
git add src/sf2_to_opxy/audio.py src/sf2_to_opxy/selection.py src/sf2_to_opxy/sf2_reader.py src/sf2_to_opxy/converter.py src/sf2_to_opxy/opxy_writer.py tests/test_selection.py tests/test_audio.py tests/test_converter.py
git commit -m "feat: port core sf2 parsing and conversion"
```

---

### Task 3: Envelope + FX send mapping

**Files:**
- Modify: `src/sf2_to_opxy/sf2_reader.py`
- Modify: `src/sf2_to_opxy/converter.py`
- Modify: `src/sf2_to_opxy/opxy_writer.py`
- Modify: `src/sf2_to_opxy/cli.py`
- Test: `tests/test_envelope.py`

**Step 1: Write the failing tests**

```python
# tests/test_envelope.py
from sf2_to_opxy.converter import timecents_to_seconds, scale_envelope_seconds
from sf2_to_opxy.converter import map_fx_send


def test_timecents_to_seconds():
    assert round(timecents_to_seconds(0), 6) == 1.0
    assert round(timecents_to_seconds(1200), 6) == 2.0


def test_scale_envelope_seconds():
    assert scale_envelope_seconds(0.0) == 0
    assert scale_envelope_seconds(360.0) == 32767


def test_fx_send_mapping():
    # 50% -> about half of 32767
    assert 16000 <= map_fx_send(50.0) <= 17000
```

**Step 2: Run tests to verify they fail**

Run: `pytest tests/test_envelope.py -v`
Expected: FAIL because functions do not exist.

**Step 3: Write minimal implementation**

- Add `timecents_to_seconds`, `scale_envelope_seconds`, `centibels_to_level`, and `map_fx_send` helpers.
- In `sf2_reader.py`, compute per-zone amp+filter envelope values from generator sums (timecents/centibels), and capture per-zone `chorus_send` and `reverb_send` values.
- In `converter.py`, pick a preset-level envelope (mode of zone envelopes; log if mixed) and preset-level FX send pair (mode; log if mixed), then pass into writer.
- In `opxy_writer.py`, apply envelope values to patch `envelope.amp` and `envelope.filter`, and set `fx.params[6]` (delay send proxy for SF2 chorus) and `fx.params[7]` (reverb send). Enable `fx.active` if either send > 0.
- Update CLI to log envelope/FX mapping decisions.

**Step 4: Run tests to verify they pass**

Run: `pytest tests/test_envelope.py -v`
Expected: PASS.

**Step 5: Commit**

```bash
git add src/sf2_to_opxy/sf2_reader.py src/sf2_to_opxy/converter.py src/sf2_to_opxy/opxy_writer.py src/sf2_to_opxy/cli.py tests/test_envelope.py
git commit -m "feat: map envelopes and fx sends"
```

---

### Task 4: `.preset` directory naming + logging enhancements

**Files:**
- Modify: `src/sf2_to_opxy/opxy_writer.py`
- Modify: `src/sf2_to_opxy/converter.py`
- Test: `tests/test_writer.py`

**Step 1: Write the failing test**

```python
# tests/test_writer.py
from sf2_to_opxy.opxy_writer import ensure_preset_dir


def test_ensure_preset_dir_suffix(tmp_path):
    out = ensure_preset_dir(tmp_path / "MyPreset")
    assert str(out).endswith(".preset")
```

**Step 2: Run test to verify it fails**

Run: `pytest tests/test_writer.py -v`
Expected: FAIL because `ensure_preset_dir` does not exist.

**Step 3: Write minimal implementation**

- Add `ensure_preset_dir` helper that appends `.preset` if missing.
- Use it in both drum and multisample writers.
- Expand log entries for discarded velocity layers and downselected zones (include preset + zone identifiers).

**Step 4: Run test to verify it passes**

Run: `pytest tests/test_writer.py -v`
Expected: PASS.

**Step 5: Commit**

```bash
git add src/sf2_to_opxy/opxy_writer.py src/sf2_to_opxy/converter.py tests/test_writer.py
git commit -m "feat: enforce .preset naming and improve logging"
```

---

### Task 5: Documentation + release notes

**Files:**
- Modify: `README.md`
- Modify: `NOTICE.md`

**Step 1: Update docs**

- Document usage, velocity options, resample defaults (22.05 kHz/16-bit), A0–C8 mapping, FX send mapping (SF2 chorus -> OP-XY delay send), and envelope scaling.
- Note that FX1 should be a chorus effect to best match SF2 chorus.
- Add credits for sf2utils and OP-PatchStudio MIT.

**Step 2: Commit**

```bash
git add README.md NOTICE.md
git commit -m "docs: add usage and mapping notes"
```

---

### Task 6: Validate on JV-1010

**Files:**
- Modify: none (output only)

**Step 1: Run converter**

Run:
```
python3 sf2_to_opxy.py /Volumes/ExtFS/charlesvestal/Downloads/op-xy/Roland_JV-1010.sf2 --out /Volumes/ExtFS/charlesvestal/Downloads/op-xy/converted/Roland_JV-1010
```
Expected: `.preset` directories with updated `patch.json` envelopes and FX send mapping, plus `conversion-log.json/txt` summarizing discards.

**Step 2: Spot-check one preset**

- Verify `patch.json` has non-default envelope values where present and `fx.params[6/7]` populated.

